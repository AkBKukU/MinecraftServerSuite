#!/bin/bash

sysdate=$(date +"20%y-%m-%d")

mcDir="/var/minecraftd"
backupDir="/var/minecraftd/backups"
backupsToKeep=5

# Prefered server version/type
# vanilla
# cb-rb
# cb-beta
# cb-dev
serverType="cb-dev"


# getNewLink
# 
# Parses the Minecraft download page for the link for the newest version of Minecraft
function getNewLink ()
{	

	case $serverType in 

		'vanilla')
			# Link to Minecraft download page
			PAGE="https://minecraft.net/download"

			# Get page HTML as raw text
			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before and after the link
			before="https"
			after='.jar" class="download-link" data-dist="server"'

			# Find the points in the page HTML where the server download link is
			end=$(awk -v a="$RAW_PAGE" -v b="$after" 'BEGIN{print index(a,b)}')
			start=`expr $(awk -v a="${RAW_PAGE:$(expr $end - 120):120}" -v b="$before" 'BEGIN{print index(a,b)}') + $end - 121`

			# Return the download link as a string
			echo "${RAW_PAGE:$start:$(expr $end - $start)}jar"
			;;

		'cb-rb')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-rb"
			after='.jar"'
			before='href="'

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "https://dl.bukkit.org${RAW_PAGE:$start:$(expr $end - 1)}.jar"
			;;

		'cb-beta')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-beta"
			after='.jar"'
			before='href="'

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "https://dl.bukkit.org${RAW_PAGE:$start:$(expr $end - 1)}.jar"
			;;

		'cb-dev')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-dev"
			after='.jar"'
			before='href="'

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "https://dl.bukkit.org${RAW_PAGE:$start:$(expr $end - 1)}.jar"
			;;
	esac
}


# getNewestVersion
# 
# Parses the Minecraft wiki page to find the newest version number of Minecraft
function getNewestVersion ()
{

	case $serverType in 

		'vanilla')
			# Link to Minecraft wiki page
			PAGE="http://minecraft.gamepedia.com/Minecraft"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="<dt>Computer</dt>"
			after='</a>'
			before="\">"

			# Half the page because it is huge and the version number is located in the second half
			HALF_PAGE=${RAW_PAGE:0:$(expr ${#RAW_PAGE} / 2 ) }

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$HALF_PAGE" -v b="$close" "BEGIN{print index(a,b)}")
			area=${HALF_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}') + $astart + 1`
			end=$(awk -v a="${HALF_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}")

			# Return the version number as a string
			echo "${HALF_PAGE:$start:$(expr $end - 1)}"
			;;

		'cb-rb')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-rb"
			after='">'
			before='version '

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "${RAW_PAGE:$start:$(expr $end - 1)}"
			;;

		'cb-beta')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-beta"
			after='">'
			before='version '

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "${RAW_PAGE:$start:$(expr $end - 1)}"
			;;

		'cb-dev')
			# Link to Craftbukkit download page
			PAGE="https://dl.bukkit.org/downloads/craftbukkit/"

			# Get page HTML as raw text

			RAW_PAGE=$(wget "$PAGE" -q -O -)

			# Set text that comes before, after, and is near the info
			close="chan-dev"
			after='">'
			before='version '

			# Get the area of the part that is close starts because there are few unique ids on the page
			astart=$(awk -v a="$RAW_PAGE" -v b="$close" "BEGIN{print index(a,b)}" 2>/dev/null ) 
			area=${RAW_PAGE:$astart}

			# Find the points in the page HTML where the info is
			start=`expr $(awk -v a="$area" -v b="$before" 'BEGIN{print index(a,b)}' 2>/dev/null ) + $astart + ${#before} - 1` 
			end=$(awk -v a="${RAW_PAGE:$start}" -v b="$after" "BEGIN{print index(a,b)}" 2>/dev/null ) 

			# Return the version number as a string
			echo "${RAW_PAGE:$start:$(expr $end - 1)}"
			;;
	esac

}

# getCurrentVersion
# 
# Run a copy of the server in the tmp folder to get it's version
function getCurrentVersion ()
{
	# Copy to a new temp directory
	mkdir /tmp/mcManager/
	sudo cp "$mcDir/minecraft-server.jar" /tmp/mcManager/

	# Start the server to generate a log file. It will stop on the eula agreement
	cd /tmp/mcManager/
	java -Xms512M -Xmx1G -jar ./minecraft-server.jar &>> /dev/null

	# Get latest log as raw text
	RAW_PAGE=$(cat /tmp/mcManager/logs/latest.log)

	# Set text that comes before the version number
	before="version "

	# Find the point in the log where the version number
	start=$(awk -v a="$RAW_PAGE" -v b="$before" 'BEGIN{print index(a,b)}')

	# Return the download link as a string after cutting off the end
	echo "$(echo ${RAW_PAGE:$(expr $start + ${#before} - 1 )} | sed 's/\s.*$//' | tail -1 )"

	rm -r /tmp/mcManager/

}


# checkForVanillaUpdate
# 
# Takes the newest version number and compares it to the currently running one to see if they match.
function checkForUpdate ()
{
	if [ "$(getCurrentVersion)" != "$(getNewestVersion)" ]
	then
		echo "Not Up to Date!"
	else
		echo "Up to date"
	fi
}


# autoUpdate
# 
# Checks for any updates and automaticaly applies them
function autoUpdate ()
{
	if [ "$(checkForUpdate)" == "Not Up to Date!" ]
	then
		updateMinecraft
	else
		echo "No update needed"
	fi
}


# installMinecraft
# 
# Installs the Minecraft server and sets it up as a system service
function installMinecraft ()
{

	rootTest

	# Setup /var/minecraft
	mkdir "$mcDir"

	# Download program
	updateMinecraft

	# Put files in place
	updatemcManager

	# Accept EULA
	getYesNo "Do you accept the Minecraft server eula (https://account.mojang.com/documents/minecraft_eula)?"
	if [ "$?" == "1" ]
		then
		service minecraftd start
        until [ -f "$mcDir/eula.txt" ]
        do
            sleep 1
        done
		sed -i 's/^eula=false$/eula=true/' "$mcDir/eula.txt"

	fi

	# Generate Files
	service minecraftd start
    until [ -f "$mcDir/server.properties" ]
    do
        sleep 1
    done
	service minecraftd stop

	# Link server.properties to /etc
	unlink /etc/minecraftd.conf
	ln -s "$mcDir/server.properties" /etc/minecraftd.conf

	# Add ops
	echo -n "Users to op (Seperate with spaces): "
	read ops
	echo "$ops" | sed 's/ /\n/' >> "$mcDir/ops.txt"

	
}


# updateMinecraft
# 
# Updates Minecraft
function updateMinecraft ()
{	
	rootTest

	service minecraftd stop

	# Download program
	wget $(getNewLink) -O "$mcDir/minecraft-server.jar"
	
	service minecraftd start
}

# backupMinecraft
# 
# Backs up the entire Minecraft setup and worlds
function backupMinecraft ()
{

	rootTest

	mkdir $backupDir

	backupName="$sysdate-$(getCurrentVersion)-Backup"
	tar -czf $backupDir/$backupName.tar.gz $mcDir
}

# autoBackupMinecraft
# 
# Backs up Minecraft and checks if there are more backups than wanted
function autoBackupMinecraft ()
{

	rootTest

	backupMinecraft

	cd $backupDir

	files=(*)
	numfiles=${#files[@]}
	echo "$backupsToKeep < $numfiles"

	if [ "$backupsToKeep" -lt "$numfiles" ]
		then
			rm "${files[0]}"
	fi

}


# updatemcManager
# 
# Installs all the mcManager files
function updatemcManager ()
{

	rootTest

	# Put files in place
	cp start-minecraft "$mcDir/minecraftd"
	ln -s "$mcDir/minecraftd" /usr/sbin/minecraftd
	cp mcManager "$mcDir/mcManager"
	ln -s "$mcDir/mcManager"/usr/sbin/mcManager
	cp service-minecraft /etc/init.d/minecraftd
	
	# Set to run on startup
	update-rc.d minecraftd defaults
}


# status
# 
# Returns current information about the server
function updatemcManager ()
{

	rootTest

	echo "Current Version: $(getCurrentVersion) Newest Version: $(getNewestVersion)"
}

# getYesNo
# 
# Asks a given question and only accepts a yes or no answer
function getYesNo ()
{	
	# Set default return
	output=2

	# Get question to ask
	message=$1

	# Get a valid response from user
	valid=false
	until [ $valid == true ]
	do
	
		# Ask Question and get response
		echo -n "$message (y/n): "
		read choice

		# Uppercase response
		choice=$(echo "${choice^^}" )

		# Test if valid
		case $choice in
			"Y"|"YES")
				output=1
				valid=true
				;;

			"N"|"NO")
				output=0
				valid=true
				;;
		esac
	done

	# Return answer
	return $output
}

# rootTest
# Tests if the script was run qith root permissions and tells the user they need to if they didn't.
function rootTest ()
{
	if [[ $EUID -ne 0 ]] 
	then
   		echo "You need to run this as root to be able to make system changes"
		echo -e "Run \"sudo $0\" next time"
		exit 1
	fi
}



# Logic
case $1 in


	'getNewLink')
		getNewLink
		;;

	'getNewestVersion')
		getNewestVersion
		;;

	'getCurrentVersion')
		getCurrentVersion
		;;

	'checkForUpdate')
		checkForUpdate
		;;

	'autoUpdate')
		autoUpdate
		;;

	'updateMinecraft')
		updateMinecraft
		;;

	'installMinecraft')
		installMinecraft
		;;

	'backupMinecraft')
		backupMinecraft
		;;

	'autoBackupMinecraft')
		autoBackupMinecraft
		;;

	'updatemcManager')
		updatemcManager
		;;

	'status')
		updatemcManager
		;;

	*)
	    echo "Usage: $0 {getNewVanillaLink|getNewVanillaVersion|getCurrentVersion|checkForVanillaUpdate|installMinecraft|updatemcManager}" >&2
	    exit 3
		;;
esac

